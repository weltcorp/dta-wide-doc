# User Domain 요구사항 명세서

## 개요
User Domain은 사용자 관리, 인증, 인가(IAM), 주기 관리를 담당하는 핵심 도메인입니다. 이 문서는 User Domain 및 IAM(Identity and Access Management)의 상세 요구사항을 정의합니다.

## 1. 기능 요구사항

### 1.1 사용자 관리
#### 사용자 등록
- 이메일과 비밀번호를 통한 회원가입
- OAuth 2.0을 통한 소셜 로그인 (Google, GitHub)
- 이메일 중복 확인
- 비밀번호 복잡도 검증
- 인증된 이메일을 통한 회원가입 (Auth 도메인과 연동)

#### 사용자 정보 관리
- 프로필 정보 조회/수정
- 비밀번호 변경
- 계정 비활성화/삭제
- 마지막 로그인 시간 추적
- 접속 이력 관리

#### 프로필 관리
- 기본 프로필 정보 (이름, 닉네임, 프로필 이미지)
- 확장 프로필 정보 (소속, 직책, 연락처)
- 프로필 이미지 업로드/관리
- 프로필 공개 범위 설정

### 1.2 인증
> **참고**: 인증 관련 기능은 Auth 도메인으로 이동되었습니다. 자세한 내용은 [Auth 도메인 요구사항](../auth/requirements.md)을 참조하세요.

### 1.3 IAM(Identity and Access Management)

#### IAM 개요
- IAM은 사용자 접근 제어 관리를 위한 종합적인 시스템
- 주체(Principal), 역할(Role), 권한(Permission), 정책(Policy) 관리
- 세분화된 접근 제어 및 최소 권한 원칙을 구현
- 중앙화된 권한 관리 제공

#### 역할 관리
- 역할 생성, 수정, 삭제 기능
- 역할에 권한 할당 및 회수
- 역할 계층 구조 지원
- 역할 할당 이력 관리
- 역할별 사용자 목록 조회

#### 권한 관리
- 리소스별 권한 정의
- 권한의 생성, 수정, 삭제 기능
- 시스템 기본 권한 제공
- 커스텀 권한 생성 지원
- 권한 충돌 해결 메커니즘

#### 정책 기반 접근 제어
- JSON 기반 정책 정의
- 조건부 접근 정책 지원
- 사용자별 직접 정책 할당
- 정책 우선순위 관리
- 정책 평가 엔진

#### 세션 및 컨텍스트 관리
- 요청 컨텍스트 기반 권한 평가
- 속성 기반 접근 제어(ABAC) 지원
- 임시 접근 권한(세션) 관리
- 세션 제한 및 종료 기능

#### 권한 위임
- 일시적 권한 위임 기능
- 위임 기간 설정
- 위임 가능한 권한 범위 제한
- 위임 이력 추적

#### 접근 분석 및 리포팅
- 사용자별 권한 리포트
- 리소스별 접근 권한 분석
- 미사용 권한 식별
- 과도한 권한 식별 및 알림
- 규정 준수 감사 보고서

### 1.4 조직 관리
#### 조직 구조
- 조직 계층 구조 관리
- 부서/팀 관리
- 사용자-조직 매핑
- 조직 간 관계 설정
- 조직 정보 이력 관리

#### 멤버십 관리
- 조직 멤버 초대/승인
- 멤버 역할 관리
- 멤버 상태 관리
- 멤버십 이력 관리
- 조직 간 멤버 이동

### 1.5 사용자 주기 관리

#### 주기 생성
- 사용자별로 특정 사이트에 대한 주기를 생성할 수 있어야 함
- 주기는 시작일과 종료일을 가져야 함
- 동일 사용자의 동일 사이트에 대해 기간이 중복되는 주기를 생성할 수 없음
- 동일 사용자의 동일 사이트에 대해 활성 상태의 주기가 이미 존재하는 경우 새로운 주기를 생성할 수 없음

#### 주기 상태 관리
- 주기는 다음 상태를 가질 수 있음:
  - PENDING: 대기 중
  - ACTIVE: 활성
  - COMPLETED: 완료
  - SUSPENDED: 일시 중지
  - CANCELLED: 취소
- 상태 변경 시 변경 사유를 기록할 수 있어야 함
- 상태 변경은 다음 규칙을 따라야 함:
  - PENDING → ACTIVE, CANCELLED
  - ACTIVE → COMPLETED, SUSPENDED
  - SUSPENDED → ACTIVE, CANCELLED
  - COMPLETED → (변경 불가)
  - CANCELLED → (변경 불가)

#### 주기 조회
- 사용자별 주기 목록을 조회할 수 있어야 함
- 상태별 필터링이 가능해야 함
- 사이트별 필터링이 가능해야 함
- 페이지네이션을 지원해야 함

## 2. 비기능 요구사항

### 2.1 성능
#### 응답 시간
- 로그인 처리: 300ms 이내 (95번째 백분위수)
- 사용자 정보 조회: 100ms 이내 (95번째 백분위수)
- 권한 검사: 50ms 이내 (99번째 백분위수)

#### 처리량
- 초당 100개 이상의 로그인 요청 처리
- 초당 1000개 이상의 권한 검사 처리
- 동시 접속자 10,000명 이상 지원

#### 확장성
- 사용자 수 100만명까지 선형 확장
- 조직 수 10,000개까지 지원
- 역할/권한 조합 1,000개 이상 지원

#### IAM 성능
- 권한 평가: 20ms 이내 (99번째 백분위수)
- 정책 업데이트 반영: 5초 이내
- 역할 할당: 100ms 이내 (95번째 백분위수)
- 초당 5,000개 이상의 IAM 요청 처리

### 2.2 가용성
#### 서비스 가용성
- 서비스 가용성 99.99% 이상
- 계획된 다운타임 없이 업데이트 가능
- 지역별 장애 대응을 위한 다중화

#### 데이터 지속성
- 사용자 데이터 백업 주기적 수행
- 데이터 복구 시간 4시간 이내
- 데이터 정합성 보장

### 2.3 보안
#### 데이터 보안
- 비밀번호 해시화 (Argon2 알고리즘)
- 중요 데이터 암호화 저장
- 개인정보 마스킹 처리
- 데이터 접근 감사 로깅

#### 통신 보안
- 모든 API 통신 TLS 1.3 적용
- API 요청/응답 데이터 암호화
- CORS 정책 적용
- HTTP 보안 헤더 설정

#### 보안 모니터링
- 로그인 시도 모니터링
- 권한 변경 감사
- 비정상 행위 탐지
- 보안 이벤트 알림

#### IAM 보안
- 권한 변경 승인 워크플로우
- 최소 권한 원칙 적용
- 특권 계정 관리 및 모니터링
- 정책 버전 관리 및 롤백 기능
- 서비스 계정 권한 관리

### 2.4 운영성
#### 모니터링
- 사용자 활동 로깅
- 성능 메트릭 수집
- 에러 추적 및 알림
- 사용량 통계 대시보드

#### 관리 도구
- 사용자 관리 콘솔
- 권한 관리 인터페이스
- 조직 관리 도구
- 감사 로그 조회 도구

### 2.5 주기 관리 관련 비기능 요구사항

#### 성능
- 주기 생성/수정/조회는 1초 이내에 응답해야 함
- 주기 목록 조회는 페이지당 최대 20개 항목으로 제한
- 캐시를 활용하여 빈번한 조회 요청에 대한 성능 최적화

#### 보안
- 사용자는 자신의 주기만 관리할 수 있음
- 모든 주기 관련 API는 인증이 필요함
- 주기 상태 변경 이력은 감사를 위해 기록되어야 함

#### 데이터 정합성
- 중복 주기 생성 방지를 위한 동시성 제어
- 상태 변경 규칙의 엄격한 적용
- 모든 시간 관련 처리는 TimeMachine 서비스 사용

### 2.6 IAM 관련 비기능 요구사항

#### 확장성
- 수백만 개의 정책 처리 지원
- 수천 개의 역할 정의 지원
- 복잡한 정책 평가 로직의 효율적 처리
- 대규모 조직 구조 지원

#### 관리성
- 역할 및 권한 관리 UI 제공
- 정책 시뮬레이션 도구
- 정책 변경 영향 분석 도구
- IAM 설정 배포 및 동기화 메커니즘

#### 상호운용성
- 표준 OAuth/OIDC 프로토콜 준수
- SAML 2.0 지원
- 외부 IAM 시스템과의 통합
- API 기반 IAM 관리 인터페이스

## 3. 제약사항

### 3.1 기술 제약
- NestJS 기반 구현
- PostgreSQL 데이터베이스 사용
- Redis 세션 스토어 사용
- ElasticSearch 로그 저장

### 3.2 보안 제약
- GDPR 컴플라이언스
- HIPAA 규정 준수 (해당 시)
- PCI DSS 요구사항 충족 (해당 시)
- ISMS 인증 기준 준수

### 3.3 규제 제약
- 데이터 보관 기간 준수
- 개인정보 처리 방침 준수
- 약관 변경 절차 준수
- 동의 철회 처리 보장

### 3.4 주기 관리 제약사항
- 모든 시간은 UTC로 저장
- 주기의 시작일은 종료일보다 이전이어야 함
- 주기 기간은 최소 1일 이상이어야 함
- 상태 변경 시 이전 상태와 동일한 상태로 변경할 수 없음

### 3.5 IAM 제약사항
- 모든 IAM 정책은 JSON 형식으로 저장
- 정책 크기는 최대 16KB로 제한
- 사용자당 최대 1,000개의 정책 할당 가능
- 권한 평가 깊이는 최대 5단계로 제한
- 정책 업데이트는 5분 이내에 전체 시스템에 반영되어야 함

## 4. 구현 우선순위

### Phase 1 (MVP)
1. 기본 사용자 등록/인증
2. 핵심 IAM 기능(역할, 권한)
3. 프로필 관리
4. 기본 조직 관리

### Phase 2
1. OAuth 통합
2. 정책 기반 접근 제어
3. 2FA 구현
4. IAM 감사 로깅

### Phase 3
1. 고급 조직 관리
2. 고급 IAM 기능(정책 시뮬레이션, 권한 추천)
3. 고급 보안 기능
4. IAM 관리 도구 고도화

## 5. 용어 정의

| 용어 | 설명 |
|------|------|
| 사용자 | 시스템에 등록된 개인 또는 서비스 계정 |
| 역할 | 권한들의 논리적 그룹 |
| 권한 | 특정 리소스에 대한 접근 또는 작업 수행 권리 |
| 정책 | 접근 제어를 정의하는 JSON 문서 |
| 주체 | IAM 시스템에서 접근 제어 대상이 되는 엔티티(사용자, 서비스 계정 등) |
| 리소스 | 접근이 제어되는 시스템 내 객체 |
| 조직 | 사용자들의 논리적 그룹 |
| 토큰 | 인증 및 권한 부여를 위한 암호화된 문자열 |
| 주기 | 사용자가 특정 사이트에서 활동하는 기간을 나타내는 단위 |
| 사이트 | 사용자가 주기를 가질 수 있는 서비스 제공 장소 |
| RBAC | Role-Based Access Control, 역할 기반 접근 제어 |
| ABAC | Attribute-Based Access Control, 속성 기반 접근 제어 |

## 변경 이력
| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|-----------|
| 0.1.0 | 2025-03-19 | bok@weltcorp.com | 최초 작성 |
| 0.1.1 | 2025-03-20 | bok@weltcorp.com | IAM 요구사항 확장 |