# User 도메인 비즈니스 규칙

## 1. 사용자 관리 규칙

### 1.1 사용자 등록
- 모든 사용자는 유효한 AccessCode로만 등록 가능
- 이메일 주소는 고유해야 함
- 비밀번호는 최소 8자 이상이어야 함
- 이메일 인증은 24시간 이내에 완료되어야 함

### 1.2 계정 상태
- 비활성 계정은 30일 후 자동 삭제됨
- 로그인 실패 5회시 계정이 자동으로 잠김
- 계정 잠금 해제는 관리자 승인 필요
- 삭제된 계정은 30일 이내 복구 가능

### 1.3 프로필 관리
- 사용자 이름은 2-50자 사이여야 함
- 프로필 이미지는 5MB 이하여야 함
- 전화번호는 국가 코드를 포함해야 함
- 언어 설정은 기본값 'ko-KR'

## 2. 인증/인가 규칙

### 2.1 토큰 관리
- Access 토큰 유효기간: 1시간
- Refresh 토큰 유효기간: 2주
- 동시 접속은 최대 3개 디바이스까지 허용
- 비밀번호 변경시 모든 토큰 무효화

### 2.2 권한 관리
- 기본 사용자 역할: USER
- 관리자 권한은 상위 관리자만 부여 가능
- 권한 변경은 감사 로그 필수
- 임시 권한은 최대 24시간까지만 유효

### 2.3 IAM 역할 할당
- SYSTEM_ADMIN 역할은 다중 승인자의 승인 필요
- 역할 할당 시 만료일 설정 가능 (최대 1년)
- 조직 범위 역할은 해당 조직 관리자만 할당 가능
- 사용자는 최대 10개까지 동시 역할 할당 가능
- 역할 할당 시 반드시 할당 사유 입력 필요

### 2.4 IAM 승인 워크플로우
- 자동 승인 역할: TEAM_ADMIN, CONTENT_EDITOR, USER
- 단일 승인 역할: SITE_ADMIN, ORG_ADMIN
- 다중 승인 역할: SYSTEM_ADMIN (최소 2명의 승인자 필요)
- 승인 요청은 14일 이내 처리되어야 함
- 미처리된 승인 요청은 14일 후 자동 만료

### 2.5 IAM 역할 회수
- 역할 회수 시 반드시 회수 사유 입력 필요
- 회수된 역할은 즉시 효력 상실
- 회수 작업은 역할 할당자 또는 상위 권한자만 가능
- 회수 작업은 감사 로깅 필수
- 자동 만료된 역할은 시스템에 의해 자동 회수

## 3. 주기 관리 규칙

### 3.1 치료 주기
- 주기는 최대 12주까지 설정 가능
- 한 사용자는 동시에 하나의 활성 주기만 가능
- 주기 시작일은 미래 날짜로 설정 불가
- 주기 종료 후 7일간 데이터 수정 가능

### 3.2 설문 관리
- 일일 설문은 해당일 23:59까지 제출 가능
- 주간 설문은 다음 주 월요일까지 제출 가능
- 미제출 설문은 자동으로 '미완료' 처리
- 설문 수정은 제출 후 24시간 이내만 가능

## 4. 데이터 처리 규칙

### 4.1 개인정보 처리
- 민감정보는 암호화하여 저장
- 개인정보 수정이력 5년간 보관
- 탈퇴 시 개인정보 즉시 익명화
- 마케팅 동의 철회 시 관련 정보 즉시 삭제

### 4.2 데이터 보존
- 치료 데이터는 10년간 보관
- 로그인 기록은 1년간 보관
- 접속 로그는 90일간 보관
- 임시 데이터는 7일 후 자동 삭제

## 5. 알림 규칙

### 5.1 이메일 알림
- 회원가입 완료시 환영 이메일 발송
- 비밀번호 변경시 알림 이메일 발송
- 주기 시작 3일 전 알림 이메일 발송
- 미완료 설문 있을 경우 매일 오전 10시 알림

### 5.2 푸시 알림
- 일일 설문 오전 9시 알림
- 주간 설문 월요일 오전 9시 알림
- 중요 공지사항 발생시 즉시 알림
- 알림은 방해금지 시간(22:00-08:00) 제외

## 6. 감사 및 모니터링 규칙

### 6.1 감사 로그
- 모든 권한 변경 기록
- 개인정보 접근 기록
- 중요 데이터 변경 기록
- 시스템 설정 변경 기록

### 6.2 모니터링
- 비정상 로그인 시도 감지
- 데이터 접근 패턴 모니터링
- API 사용량 모니터링
- 에러 발생 모니터링 

## 7. IAM 통합 규칙

### 7.1 권한 검증
- 모든 API 요청은 권한 검증 필수
- 권한 검증 실패 시 403 Forbidden 응답
- 권한 검증 결과는 5분간 캐싱
- 권한 검증 실패는 감사 로그에 기록
- 연속 5회 이상 권한 검증 실패 시 알림 발생

### 7.2 권한 범위
- 글로벌 범위: 시스템 전체에 적용
- 조직 범위: 특정 조직과 그 하위 팀에 적용
- 팀 범위: 특정 팀에만 적용
- 리소스 범위: 특정 리소스에만 적용
- 범위가 지정되지 않은 권한은 글로벌 범위로 간주

### 7.3 권한 위임
- 임시 권한 위임은 최대 72시간까지 가능
- 위임된 권한은 원래 권한보다 높을 수 없음
- 위임 작업은 감사 로깅 필수
- 위임 권한은 위임자에 의해 언제든지 회수 가능
- 위임 권한 사용 시 실제 사용자와 위임자 모두 로깅

### 7.4 권한 충돌 해결
- 동일 리소스에 대해 다중 역할 보유 시 가장 높은 권한 적용
- 허용 권한과 거부 권한이 충돌할 경우 거부 권한 우선
- 범위가 좁은 권한이 범위가 넓은 권한보다 우선
- 임시 권한은 영구 권한보다 우선
- 명시적 권한은 상속된 권한보다 우선

### 7.5 권한 감사
- 모든 권한 변경은 감사 로그에 기록
- 권한 감사 로그는 최소 2년간 보관
- 중요 권한 변경은 관리자에게 실시간 알림
- 월간 권한 감사 리포트 자동 생성
- 미사용 권한은 90일 후 자동 검토 대상

## 8. 변경 이력
| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|-----------|
| 0.1.0 | 2025-03-16 | bok@weltcorp.com | 최초 작성 |
| 0.2.0 | 2025-03-20 | bok@weltcorp.com | IAM 통합 규칙 추가 |