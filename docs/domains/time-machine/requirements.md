# TimeMachine 도메인 요구사항 명세서

## 1. 개요
TimeMachine은 모든 시스템 컴포넌트에서 사용하는 시간을 중앙에서 제어하는 핵심 도메인입니다. 각 시스템은 자체적으로 시간을 생성하지 않고 항상 TimeMachine을 통해 현재 시간을 조회해야 합니다.

## 2. 용어 정의

| 용어 | 설명 | 비고 |
|------|------|------|
| TimeMachine | 시스템의 시간을 중앙에서 관리하는 핵심 엔티티 | 모든 시간 관련 작업의 중심점 |
| TimeContext | 사용자 또는 디바이스별 시간 정보를 관리하는 컨텍스트 | 시간 오프셋, 시간대 정보 포함 |
| TimeOffset | 기준 시간으로부터의 차이값 | 절대 시간 또는 상대 시간으로 표현 |
| DeviceId | 비로그인 사용자를 식별하기 위한 고유 식별자 | |

## 3. 기능 요구사항

### 3.1 시간 조회 기능
1. 현재 시간 조회
   - 사용자 ID 또는 디바이스 ID 기반 조회
   - 시간 오프셋 적용된 결과 제공
   - 밀리초 단위까지 정확도 보장

2. 시간대별 시간 조회
   - 특정 시간대 기준 시간 제공
   - 일광절약시간(DST) 고려

### 3.2 시간 설정 기능
1. 관리자 시간 설정
   - 절대 시간 설정
   - 상대 시간(오프셋) 설정
   - 사용자/그룹별 시간 설정

2. 배치 작업용 시간 설정
   - 대량 처리를 위한 시간 설정
   - 작업 단위별 독립적 시간 관리

### 3.3 시간 동기화 기능
1. 노드 간 시간 동기화
   - 분산 환경에서의 시간 일관성 유지
   - 동기화 주기 설정

2. 외부 시스템 연동
   - NTP 서버 연동
   - 표준시 동기화

## 4. 비기능 요구사항

### 4.1 성능 요구사항
1. 응답 시간
   - 시간 조회: 50ms 이내
   - 시간 설정: 100ms 이내

2. 처리량
   - 동시 요청: 초당 1000건 이상
   - 피크 시간대: 초당 2000건 처리

3. 확장성
   - 사용자 수: 최대 100만명
   - 디바이스 수: 최대 200만대

### 4.2 가용성 요구사항
1. 서비스 가용성
   - 가용성: 99.99% 이상
   - 장애 복구: 1초 이내

2. 데이터 정합성
   - 시간 정확도: 1ms 이내
   - 노드 간 시간 차: 최대 10ms

### 4.3 보안 요구사항
1. 접근 제어
   - 관리자 인증/인가
   - 권한 기반 접근 통제

2. 감사
   - 시간 설정 이력 기록
   - 비정상 접근 탐지

### 4.4 운영 요구사항
1. 모니터링
   - 시간 조회 지연 모니터링
   - 사용자별 오프셋 모니터링
   - 시스템 리소스 모니터링

2. 로깅
   - 주요 작업 로깅
   - 에러 상황 상세 로깅

## 5. 제약사항

### 5.1 기술적 제약사항
1. 시간 생성
   - new Date() 직접 사용 금지
   - Date.now() 직접 사용 금지
   - 외부 라이브러리 시간 기능 오버라이드 필수

2. 개발 환경
   - NestJS 프레임워크 사용
   - TypeScript strict 모드 필수
   - Jest 기반 테스트 코드 작성

### 5.2 비즈니스 제약사항
1. 시간 관리
   - 관리자만 시간 설정 가능
   - 사용자별 독립적 시간 컨텍스트 유지
   - 시간 설정 이력 영구 보관

## 6. 도메인 규칙

### 6.1 시간 생성 규칙
- 모든 시간은 TimeMachine을 통해서만 생성
- 시스템 시간 직접 참조 금지
- 외부 라이브러리 시간 관련 기능 래핑 필수

### 6.2 시간 컨텍스트 규칙
- 사용자당 하나의 TimeContext 유지
- 로그인 사용자는 userId로 식별
- 비로그인 사용자는 deviceId로 식별

### 6.3 시간 설정 규칙
- 관리자 권한 필수
- 설정된 시간은 즉시 적용
- 과거 시간으로의 설정 제한

## 7. 도메인 이벤트

### 7.1 이벤트 목록
1. TimeSet
   - 시간이 설정되었을 때 발생
   - 설정된 시간 정보 포함

2. TimeContextChanged
   - 시간 컨텍스트가 변경되었을 때 발생
   - 변경된 컨텍스트 정보 포함

3. TimeSyncRequired
   - 노드 간 시간 동기화가 필요할 때 발생
   - 동기화 대상 노드 정보 포함

## 8. 구현 우선순위

### 8.1 Phase 1 - MVP (1개월)
- 기본 시간 조회 기능
- 관리자 시간 설정 기능
- 사용자별 시간 컨텍스트 관리

### 8.2 Phase 2 - 확장 (2개월)
- 분산 환경 지원
- 시간대 처리 기능
- 배치 작업 지원

### 8.3 Phase 3 - 고도화 (3개월)
- 성능 최적화
- 모니터링 고도화
- 외부 시스템 연동

## 변경 이력

| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|-----------|
| 0.1.0 | 2025-03-16 | bok@weltcorp.com | 최초 작성 |