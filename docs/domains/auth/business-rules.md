# Auth 도메인 비즈니스 규칙

## 1. 인증 규칙

### 1.1 로그인 규칙
- 사용자는 이메일과 비밀번호로 로그인
- OAuth 제공자를 통한 소셜 로그인 지원 ([GesundheitsID](https://www.perplexity.ai/search/gesundheitsidneun-oauthinga-ja-shhu84a6Qeiwj4PFs3BmTA#0))
- 2단계 인증(2FA) 지원
  - PIN code
  - 생체인증 (FaceID, TouchID)

### 1.2 비밀번호 규칙
- 최소 8자, 최대 32자
- 대문자, 소문자, 숫자, 특수문자 중 3가지 이상 포함
- 연속된 문자 3개 이상 사용 불가
- 이전에 사용한 비밀번호 5개는 재사용 불가
- 90일마다 변경 필요

### 1.3 계정 잠금 규칙
- 5회 연속 로그인 실패 시 계정 잠금
- 잠금 기간은 1분 (이후 재시도 허용)

### 1.4 세션 관리 규칙
- 액세스 토큰 유효 기간: 30분
- 리프레시 토큰 유효 기간: 14일
- 동시 접속 Device는 최대 1개
- Mobile 요구사항
   - 비활성 상태 30분 이내에는 간편인증/로그인 없이 사용 가능
   - 비활성 상태 30분 ~ 4시간 이내에는 간편인증(PIN code, 생체인증)으로 사용 가능
   - 비활성 상태 4시간 이후 자동 로그아웃 
     - Log out API를 호출하는 것이 아닌 로컬 캐시를 삭제하여 다시 로그인 하도록 유도

## 2. 권한 관리 규칙

### 2.1 역할 관리 규칙
- 기본 역할: ADMIN, USER, GUEST
- 사용자는 여러 역할 보유 가능
- ADMIN 역할은 시스템에서 1명 이상 필수
- 역할 삭제 시 해당 역할의 모든 권한도 삭제

### 2.2 권한 관리 규칙
- 권한은 리소스와 작업의 조합
- 기본 작업: CREATE, READ, UPDATE, DELETE, EXECUTE
- 권한 상속 지원 (상위 권한이 하위 권한 포함)
- 권한 변경 시 즉시 적용

### 2.3 접근 제어 규칙
- 리소스 접근 시 권한 검사 필수
- 권한 없는 접근 시도 시 감사 로그 기록
- IP 기반 접근 제한 지원
- 시간 기반 접근 제한 지원

## 3. 보안 정책 규칙

### 3.1 토큰 관리 규칙
- JWT 토큰 사용
- 토큰 서명에 RSA 키 사용
- 키 교체 주기: 90일
- 토큰 페이로드에 최소 정보만 포함

### 3.2 감사 로그 규칙
- 모든 인증 시도 기록
- 권한 변경 이력 기록
- 보안 정책 변경 이력 기록
- 로그 보관 기간: 1년

### 3.3 보안 헤더 규칙
- HTTPS 필수
- HSTS 헤더 사용
- CSP 헤더 설정
- X-Frame-Options 설정

### 3.4 데이터 보호 규칙
- 비밀번호는 bcrypt로 해시
- 개인정보는 암호화 저장
- 토큰은 서버 측에서만 생성
- 민감 정보는 로그에 기록 금지

## 4. 통합 규칙

### 4.1 OAuth 통합 규칙
- 지원 제공자: [GesundheitsID](https://www.perplexity.ai/search/gesundheitsidneun-oauthinga-ja-shhu84a6Qeiwj4PFs3BmTA#0)
- 제공자별 설정 관리
- 사용자 프로필 동기화
- 토큰 갱신 자동화

### 4.2 알림 규칙
- 로그인 시도 알림 (선택적)
- 비밀번호 변경 알림 (필수)
- 보안 정책 변경 알림 (관리자)
- 계정 잠금 알림 (필수)

## 5. 예외 처리 규칙

### 5.1 인증 예외
- 잘못된 인증 정보: 401 Unauthorized
- 권한 없음: 403 Forbidden
- 계정 잠금: 423 Locked
- 토큰 만료: 401 Unauthorized

### 5.2 입력 검증 예외
- 잘못된 이메일 형식: 400 Bad Request
- 약한 비밀번호: 400 Bad Request
- 중복된 사용자: 409 Conflict
- 잘못된 토큰 형식: 400 Bad Request

### 5.3 시스템 예외
- 데이터베이스 오류: 500 Internal Server Error
- 캐시 서버 오류: 500 Internal Server Error
- 외부 서비스 오류: 502 Bad Gateway
- 타임아웃: 504 Gateway Timeout

## 6. 컨센트 토큰 규칙

### 6.1 토큰 생성 규칙
1. **사용자 식별**
   - 사용자 ID는 필수이며 유효해야 함
   - 사용자는 활성 상태여야 함

2. **동의 범위**
   - 최소 하나 이상의 scope가 지정되어야 함
   - scope는 미리 정의된 값만 사용 가능
   - scope 조합의 유효성 검증 필요

3. **동의 목적**
   - 목적(purpose)은 명확하게 지정되어야 함
   - 목적은 미리 정의된 카테고리에 속해야 함
   - 다국어 지원을 위한 키 값 사용

4. **유효 기간**
   - 만료 시간은 현재 시간보다 미래여야 함
   - 최대 유효 기간은 정책으로 제한
   - 갱신 가능 여부는 목적별로 설정

5. **메타데이터**
   - 메타데이터는 선택사항
   - 제공 시 유효한 JSON 형식이어야 함
   - 민감 정보 포함 불가

### 6.2 토큰 검증 규칙
1. **형식 검증**
   - 토큰이 유효한 형식이어야 함
   - 서명이 유효해야 함
   - 필수 클레임이 모두 존재해야 함

2. **상태 검증**
   - 토큰이 만료되지 않았어야 함
   - 토큰이 취소되지 않았어야 함
   - 사용자가 활성 상태여야 함

3. **범위 검증**
   - 요청된 모든 scope가 토큰의 scope에 포함되어야 함
   - scope의 계층 구조 고려
   - scope 조합의 유효성 검증

### 6.3 토큰 취소 규칙
1. **취소 조건**
   - 활성 상태의 토큰만 취소 가능
   - 취소 사유는 필수
   - 취소된 토큰은 복구 불가

2. **연관 처리**
   - 관련 시스템에 취소 이벤트 발행
   - 사용자에게 취소 알림
   - 취소 이력 기록

### 6.4 이력 관리 규칙
1. **이력 기록**
   - 모든 토큰 작업은 이력 기록
   - 작업자 정보 포함
   - 타임스탬프는 TimeMachine 사용

2. **감사 요구사항**
   - GDPR 요구사항에 따른 이력 보관
   - 이력 데이터 암호화
   - 접근 권한 제한

## 7. 앱 토큰 규칙

### 7.1 토큰 생성 규칙
1. **앱 식별**
   - 앱 ID는 필수이며 유효해야 함
   - 앱은 활성 상태여야 함

2. **권한 범위**
   - 최소 하나 이상의 권한이 지정되어야 함
   - 권한은 미리 정의된 값만 사용 가능
   - 권한 조합의 유효성 검증 필요

3. **디바이스 ID**
   - 디바이스 ID는 ChaCha20 알고리즘으로 암호화되어야 함
   - 디바이스 ID는 유효한 형식이어야 함
   - 복호화 실패 시 토큰 발급 거부

4. **유효 기간**
   - 만료 시간은 현재 시간보다 미래여야 함
   - 최대 유효 기간은 24시간으로 제한
   - 갱신 불가능 (만료 시 재발급 필요)

### 7.2 토큰 검증 규칙
1. **형식 검증**
   - 토큰이 유효한 형식이어야 함
   - 서명이 유효해야 함
   - 필수 클레임이 모두 존재해야 함

2. **상태 검증**
   - 토큰이 만료되지 않았어야 함
   - 토큰이 취소되지 않았어야 함
   - 앱이 활성 상태여야 함

3. **권한 검증**
   - 요청된 API에 필요한 권한이 토큰에 포함되어야 함
   - 권한의 계층 구조 고려
   - 권한 조합의 유효성 검증

### 7.3 토큰 관리 규칙
1. **토큰 조회**
   - 앱 토큰 정보는 관리자 권한으로만 조회 가능
   - 조회 시 토큰 자체는 마스킹 처리
   - 마지막 사용 시간 기록

2. **토큰 취소**
   - 관리자 권한으로 토큰 취소 가능
   - 취소된 토큰은 즉시 무효화
   - 취소 이력 기록

### 7.4 보안 규칙
1. **디바이스 ID 보안**
   - 디바이스 ID는 항상 암호화된 상태로 전송
   - 복호화는 서버 측에서만 수행
   - 복호화된 디바이스 ID는 로그에 기록하지 않음

2. **토큰 사용 제한**
   - 동일 앱 ID에 대한 토큰 발급 횟수 제한
   - 비정상적인 토큰 사용 패턴 감지
   - 의심스러운 활동 시 토큰 자동 취소

## 8. 변경 이력
| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|-----------|
| 0.1.0 | 2025-03-16 | bok@weltcorp.com | 최초 작성 |
| 0.2.0 | 2025-03-17 | bok@weltcorp.com | 앱 토큰 규칙 추가 |
| 0.2.1 | 2025-03-18 | bok@weltcorp.com | 계정 잠금 규칙에 10분 후 재시도 허용 추가 |